# Versioning Migration: Versioneer to setuptools_scm

## Summary

RedBlackGraph has migrated from **versioneer** to **setuptools_scm** for version management. Both tools automatically determine version from git tags, but setuptools_scm works with modern build backends like meson-python.

## Why the Change?

- **Versioneer** was designed for setuptools and doesn't work with meson-python
- **setuptools_scm** is actively maintained and integrates with modern build systems
- Both provide automatic versioning from git tags (no manual version updates needed)

## What Changed

### Files Modified

1. **`pyproject.toml`**
   - Added `setuptools_scm>=8.0` to build requirements
   - Changed `version = "0.5.0"` to `dynamic = ["version"]`
   - Added `[tool.setuptools_scm]` configuration

2. **`redblackgraph/__init__.py`**
   - Simplified version import (no more `get_versions()`)
   - Now imports `__version__` directly from `_version.py`

3. **`meson.build`**
   - Version remains as fallback for meson's internal use
   - Added comment clarifying actual version comes from setuptools_scm

### Files to Keep (Legacy)

- **`versioneer.py`** - Can be removed (no longer needed)
- **`setup.cfg`** - `[versioneer]` section no longer used
- **`redblackgraph/_version.py`** - Will be regenerated by setuptools_scm

## How Versioning Works Now

### Version Determination

```
Git Tag       →  Package Version
─────────────────────────────────
v0.5.0        →  0.5.0
v0.5.1        →  0.5.1
v1.0.0        →  1.0.0
```

### Between Releases

If you commit after a tag, version includes commit info:
```
v0.5.1 + 3 commits  →  0.5.1.post3+git.abc1234
```

### No Tags

If no git tags exist:
```
No tags  →  0.0.0.dev0
```

## For Developers

### Version File Generation

The `_version.py` file is automatically generated:
- **During build**: `python -m build`
- **During install**: `pip install -e .`
- **By setuptools_scm**: Based on git tags and commits

### Checking Current Version

```python
# In Python
import redblackgraph
print(redblackgraph.__version__)
```

```bash
# From command line
python -c "import redblackgraph; print(redblackgraph.__version__)"

# Or using setuptools_scm directly
python -m setuptools_scm
```

### Development Installs

When installing in development mode:
```bash
pip install -e .
```

setuptools_scm will:
1. Check git tags
2. Generate `redblackgraph/_version.py`
3. Set version based on latest tag + commits

## For Release Managers

### Creating a Release

**No version files to update!** Just tag the commit:

```bash
# 1. Prepare release
git commit -am "Prepare release 0.5.1"

# 2. Create tag
git tag -a v0.5.1 -m "Release version 0.5.1"

# 3. Push tag
git push origin v0.5.1
```

GitHub Actions will automatically:
- Build wheels for all platforms
- Extract version `0.5.1` from tag `v0.5.1`
- Publish to PyPI

### Version Format

Always use the format: `v{MAJOR}.{MINOR}.{PATCH}`

Examples:
- `v0.5.1` ✓
- `v1.0.0` ✓
- `0.5.1` ✗ (missing 'v' prefix)
- `v0.5.1-rc1` ✗ (pre-releases need special handling)

## Configuration Reference

### `pyproject.toml`

```toml
[build-system]
requires = [
    # ... other requirements ...
    "setuptools_scm>=8.0",
]

[project]
dynamic = ["version"]

[tool.setuptools_scm]
write_to = "redblackgraph/_version.py"
version_scheme = "post-release"
local_scheme = "no-local-version"
```

### Version Schemes

- **`post-release`**: After tag, version becomes `X.Y.Z.postN`
- **`local_scheme = "no-local-version"`**: Excludes local version identifier for cleaner PyPI versions

## Troubleshooting

### Version shows as `0.0.0.dev0`

**Cause**: No git tags found or not in a git repository

**Solution**:
```bash
# Check tags exist
git tag

# Ensure you have at least one version tag
git tag -a v0.5.0 -m "Initial version"

# Rebuild
pip install -e . --force-reinstall
```

### Version file not found during import

**Cause**: Package installed without build step

**Solution**:
```bash
# Force reinstall
pip install -e . --force-reinstall --no-build-isolation
```

### Version doesn't match git tag

**Cause**: Stale `_version.py` file

**Solution**:
```bash
# Remove old version file
rm redblackgraph/_version.py

# Reinstall
pip install -e .
```

## Migration Checklist

If you're migrating from versioneer to setuptools_scm:

- [x] Add `setuptools_scm>=8.0` to `pyproject.toml` build requirements
- [x] Change `version = "x.x.x"` to `dynamic = ["version"]` in `pyproject.toml`
- [x] Add `[tool.setuptools_scm]` section to `pyproject.toml`
- [x] Update `__init__.py` to import `__version__` from `_version.py`
- [x] Update documentation to explain automatic versioning
- [ ] Optional: Remove `versioneer.py` (no longer needed)
- [ ] Optional: Remove `[versioneer]` section from `setup.cfg`
- [ ] Test: Build and verify version is correct

## References

- [setuptools_scm documentation](https://setuptools-scm.readthedocs.io/)
- [Semantic Versioning](https://semver.org/)
- [PEP 440 - Version Identification](https://peps.python.org/pep-0440/)
